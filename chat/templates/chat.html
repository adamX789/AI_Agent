<!DOCTYPE html>
{% load markdown_extras %}
{% load static %}
<html lang="cs">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat</title>
  <link rel="stylesheet" href="{% static 'chat.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mozilla+Text:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
  <button class="hamburger" id="hamburger">â˜°</button>
  <!-- âœ… Sidebar -->
  <aside class="sidebar" id="sidebar">
    <button class="close-btn" id="closeBtn">âœ–</button>
    <nav class="nav-links">
      <a href="{% url 'profile' %}"><button class="nav-btn">Profil</button></a>
      <a href="{% url 'chat' %}"><button class="nav-btn">Chat</button></a>
      <a href="{% url 'my_day' %}"><button class="nav-btn">MÅ¯j den</button></a>
    </nav>
    <a href="{% url 'logout' %}" style="width: 100%;"><button class="logout-btn">OdhlÃ¡sit se</button></a>
  </aside>

  <!-- âœ… Main Chat Section -->
  <main class="chat-container">
    <div class="chat-box" id="messages">
      {% for message in messages %}
      {% if message.sender == "Vy" %}
      <div class="msg msg--user">{{message.text|linebreaksbr|markdown}}</div>
      {% else %}
      <div class="msg msg--agent">{{message.text|linebreaksbr|markdown}}</div>
      {% endif %}
      {% endfor %}
    </div>

    <form class="chat-input" action="" method="POST" id="form-field">
      {% csrf_token %}
      <input type="text" placeholder="NapiÅ¡te zprÃ¡vu..." id="textInput" />
      <label for="imageInput"><button type="button" class="icon-btn">ðŸ“·</button></label>
      <input type="file" name="image" style="display: none;" id="imageInput" accept="image/*">
      <p id="fileNameDisplay"></p> <button type="submit" class="send-btn">Odeslat</button>
    </form>
  </main>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  document.getElementById("form-field").addEventListener("submit", function (event) {
    event.preventDefault();
    const text_box = document.getElementById("textInput");
    const image_box = document.getElementById("imageInput");
    const user_msg = text_box.value;

    if (user_msg.length > 0) {
      appendMessage(user_msg, "user");
      appendWaitMessage("Agent pÅ™emÃ½Å¡lÃ­.", "agent");
      const messageToRemove = document.getElementById("tempMessage")

      fetch("{% url 'chat' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ message: user_msg })
      })
        .then(response => response.json())
        .then(data => {
          appendMessage(data.response, "agent");
          messageToRemove.remove();
        });
    } else {
      appendMessage("[ObrÃ¡zek]", "user");
      appendWaitMessage("Agent pÅ™emÃ½Å¡lÃ­.", "agent");
      const messageToRemove = document.getElementById("tempMessage");
      const formData = new FormData();
      formData.append("image", image_box.files[0]);
      formData.append("csrfmiddlewaretoken", getCookie("csrftoken"));

      fetch("{% url 'chat' %}", {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          appendMessage(data.response, "agent");
          messageToRemove.remove();
        });
    }



    text_box.value = "";
  });

  function appendMessage(text, sender) {
    const container = document.getElementById("messages");
    const time = new Date();
    const time_string = time.getHours().toString().padStart(2, "0") + ":" + time.getMinutes().toString().padStart(2, "0");

    let formatted_text = text.replace(/\n/g, "<br>");
    formatted_text = marked.parse(formatted_text);

    const messageBox = document.createElement("div");
    messageBox.className = "msg msg--" + sender;
    messageBox.innerHTML = formatted_text;
    container.appendChild(messageBox);
  };

  function appendWaitMessage(text, sender) {
    const container = document.getElementById("messages");

    const messageBox = document.createElement("div");
    messageBox.className = "msg msg--" + sender;
    messageBox.id = "tempMessage"
    messageBox.innerHTML = text
    container.appendChild(messageBox);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  };
  const imageButton = document.querySelector('.icon-btn');
  const imageInput = document.getElementById('imageInput');
  const fileNameDisplay = document.getElementById('fileNameDisplay');

  imageButton.addEventListener('click', () => {
    imageInput.click();
  });
  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      fileNameDisplay.textContent = `${file.name}`;
    } else {
      fileNameDisplay.textContent = "";
    }
  });
</script>
<script src="{% static 'chat.js' %}"></script>
</body>

</html>