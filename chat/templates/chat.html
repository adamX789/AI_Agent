<!DOCTYPE html>
{% load markdown_extras %}
{% load static %}
<html lang="cs">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat</title>
  <link rel="stylesheet" href="{% static 'chat.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mozilla+Text:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
  <button class="hamburger" id="hamburger">‚ò∞</button>
  <!-- ‚úÖ Sidebar -->
  <aside class="sidebar" id="sidebar">
    <button class="close-btn" id="closeBtn">‚úñ</button>
    <img src="{% static 'images/Logo bez textu.png' %}" alt="">
    <nav class="nav-links">
      <a href="{% url 'profile' %}"><button class="nav-btn">Profil</button></a>
      <a href="{% url 'chat' %}"><button class="nav-btn">Chat</button></a>
      <a href="{% url 'my_day' %}"><button class="nav-btn">M≈Øj den</button></a>
    </nav>
    <a href="{% url 'logout' %}" style="width: 100%;"><button class="logout-btn">Odhl√°sit se</button></a>
  </aside>

  <!-- ‚úÖ Main Chat Section -->
  <main class="chat-container">
    <div class="chat-box" id="messages">
      {% for message in messages %}
      {% if message.sender == "Vy" %}
      <div class="msg msg--user">{{message.text|linebreaksbr|markdown}}</div>
      {% else %}
      <div class="msg msg--agent">{{message.text|linebreaksbr|markdown}}</div>
      {% endif %}
      {% endfor %}
    </div>

    <form class="chat-input" action="" method="POST" id="form-field">
      {% csrf_token %}
      <input type="text" placeholder="Napi≈°te zpr√°vu..." id="textInput" />
      <button type="submit" class="send-btn">Odeslat</button>
      <div class="plus-menu-wrapper">
        <button type="button" class="plus-btn" id="plusBtn">+</button>
        <div class="plus-menu" id="plusMenu">
          <button type="button">üëÄ Naƒç√≠st QR kodem (Brzy spu≈°tƒõno!)</button>
          <label for="imageInput"><button type="button" class="icon-btn">üì∑ Vyfotit fotku.</button></label>
          <input type="file" name="image" id="imageInput" style="display: none;" accept="image/*">
          <button type="button" class="record-btn">üé§ Zaznamenat zvukov√Ω z√°znam (Brzy spu≈°tƒõno!)</button>
        </div>
      </div>
      <button type="button" class="stop-btn hidden" disabled>Zastavit nahr√°v√°n√≠</button>
    </form>
    <div id="fileNameDisplay"></div>
    <audio controls class="audio-player"></audio>
  </main>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  let audioFile = null;
  let isRecording = false;
  const plusBtn = document.getElementById("plusBtn");
  const plusMenu = document.getElementById("plusMenu");

  plusBtn.addEventListener("click", () => {
    if (isRecording){
      plusMenu.style.display = "none";
    } else {
      plusMenu.style.display = plusMenu.style.display === "flex" ? "none" : "flex";
    };
  });
  document.addEventListener("click", (e) => {
    if (!plusBtn.contains(e.target) && !plusMenu.contains(e.target)) {
      plusMenu.style.display = "none";
    }
  });
  document.addEventListener("DOMContentLoaded", () => {
    const plusMenu = document.getElementById("plusMenu");
    const recordBtn = document.querySelector(".record-btn");
    const stopBtn = document.querySelector(".stop-btn");
    const audioPlayer = document.querySelector(".audio-player");
    let mediaRecorder;
    let audioChunks = [];
    recordBtn.addEventListener("click", async () => {
      isRecording = true;
      plusMenu.style.display = "none";
      stopBtn.classList.remove("hidden");
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new mediaRecorder(stream);
      mediaRecorder.start();

      mediaRecorder.addEventListener("dataavailable", event => {
        audioChunks.push(event.data);
      });
    });
    stopBtn.addEventListener("click",() => {
      mediaRecorder.stop();
      stopBtn.classList.add("hidden");
    });

    mediaRecorder.addEventListener("stop", () => {
      const audioBlob = new Blob(audioChunks,{type:"audio/wav"});
      const audioURL = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioURL;
      audioPlayer.style.display = "block";
      audioFile = new File([audioBlob], "audio.wav", {type:"audio/wav"});
    });
  });
  document.getElementById("form-field").addEventListener("submit", function (event) {
    event.preventDefault();
    const text_box = document.getElementById("textInput");
    const image_box = document.getElementById("imageInput");
    const user_msg = text_box.value;

    if (user_msg.length > 0) {
      text_box.disabled = true;
      appendMessage(user_msg, "user");
      appendWaitMessage("Agent p≈ôem√Ω≈°l√≠.", "agent");
      const messageToRemove = document.getElementById("tempMessage")

      fetch("{% url 'chat' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ message: user_msg })
      })
        .then(response => response.json())
        .then(data => {
          appendMessage(data.response, "agent");
          messageToRemove.remove();
          text_box.disabled = false;
        });
    } else if (audioFile) {
      isRecording = false;
      text_box.disabled = true;
      appendMessage("Pos√≠l√°te hlasovou zpr√°vu", "user");
      appendWaitMessage("Agent p≈ôem√Ω≈°l√≠.", "agent");
      const messageToRemove = document.getElementById("tempMessage");
      const formData = new FormData();
      formData.append("audio",audioFile);
      formData.append("csrfmiddlewaretoken", getCookie("csrftoken"));
      audioFile = null;
      const audioPlayer = document.querySelector(".audio-player");
      audioPlayer.src = "";
      audioPlayer.style.display = "none";
      fetch("{% url 'chat' %}", {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          appendMessage(data.response, "agent");
          messageToRemove.remove();
          text_box.disabled = false;
        });
      
    } else {
      text_box.disabled = true;
      appendMessage("[Obr√°zek]", "user");
      appendWaitMessage("Agent p≈ôem√Ω≈°l√≠.", "agent");
      const messageToRemove = document.getElementById("tempMessage");
      const formData = new FormData();
      formData.append("image", image_box.files[0]);
      formData.append("csrfmiddlewaretoken", getCookie("csrftoken"));
      image_box.value = '';
      document.getElementById('fileNameDisplay').textContent = '';

      fetch("{% url 'chat' %}", {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          appendMessage(data.response, "agent");
          messageToRemove.remove();
          text_box.disabled = false;
        });
    };
    text_box.value = "";
  });
  function appendMessage(text, sender) {
    const container = document.getElementById("messages");
    const time = new Date();
    const time_string = time.getHours().toString().padStart(2, "0") + ":" + time.getMinutes().toString().padStart(2, "0");

    let formatted_text = text.replace(/\n/g, "<br>");
    formatted_text = marked.parse(formatted_text);

    const messageBox = document.createElement("div");
    messageBox.className = "msg msg--" + sender;
    messageBox.innerHTML = formatted_text;
    container.appendChild(messageBox);
  };

  function appendWaitMessage(text, sender) {
    const container = document.getElementById("messages");

    const messageBox = document.createElement("div");
    messageBox.className = "msg msg--" + sender;
    messageBox.id = "tempMessage"
    messageBox.innerHTML = text
    container.appendChild(messageBox);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  };
  const imageButton = document.querySelector('.icon-btn');
  const imageInput = document.getElementById('imageInput');
  const fileNameDisplay = document.getElementById('fileNameDisplay');

  imageButton.addEventListener('click', () => {
    imageInput.click();
  });
  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      fileNameDisplay.textContent = `${file.name}`;
    } else {
      fileNameDisplay.textContent = "";
    }
  });
</script>
<script src="{% static 'chat.js' %}"></script>
</body>

</html>